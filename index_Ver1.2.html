<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nifty Options — Target & Zerodha-like Charges (Multi Contract)</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--muted:#64748b;--accent:#0369a1;--ok:#16a34a;--danger:#ef4444}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);margin:0;padding:20px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 10px 30px rgba(20,30,60,0.08);padding:20px;max-width:900px;width:100%}
    h1{font-size:18px;margin:0 0 10px;color:#0f172a}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
    .actions{display:flex;gap:8px;margin-top:10px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .btn.ghost{background:#475569}
    .btn.secondary{background:#0ea5a4}
    .panel{margin-top:16px;background:#fff;border-radius:10px;padding:12px;border:1px solid #eef2f7}
    .row{display:flex;justify-content:space-between;padding:8px 6px;border-bottom:1px solid #f1f5f9}
    .row:last-child{border-bottom:none}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px;color:var(--muted)}
    .value-rupee{font-weight:600}
    .profit{color:var(--ok);font-weight:700}
    .loss{color:var(--danger);font-weight:700}
    .records{margin-top:12px}
    .record{background:#f8fafc;border-radius:8px;padding:8px;margin-bottom:8px;border:1px solid #e6eef7}
    .record .meta{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .record .meta div{min-width:80px}
    .record button{background:transparent;border:0;color:#ef4444;cursor:pointer}
    .aggregate{background:#eef6ff;border-left:4px solid var(--accent)}
    @media (max-width:720px){.grid{grid-template-columns:1fr 1fr}}
    @media (max-width:420px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="card">
    <h1>Nifty Options — Multi Contract Notes</h1>

    <div class="grid">
      <div>
        <label for="buy">Buy Price</label>
        <input id="buy" type="number" step="any" placeholder="e.g. 40"  />
      </div>
      <div>
        <label for="sell">Sell Price</label>
        <input id="sell" type="number" step="any" placeholder="e.g. 45"  />
      </div>
      <div>
        <label for="qty">Quantity (contracts)</label>
        <input id="qty" type="number" value="1" min="0" />
      </div>
      <div>
        <label for="lot">Lot Size</label>
        <input id="lot" type="number" value="75" min="1" />
      </div>
    </div>

    <div class="actions">
      <button id="addBtn" class="btn secondary">+ Contract Note</button>
      <button id="clearBtn" class="btn ghost">Clear Inputs</button>
      <button id="clearAllBtn" class="btn">Clear All Records</button>
      <div style="flex:1"></div>
      <div class="small muted">Add many contract notes — aggregates appear at bottom.</div>
    </div>

    <div id="records" class="records" aria-live="polite"></div>

    <!-- aggregate will be rendered as a record at the bottom of records -->
  </div>

<script>
(function(){
  function $(id){return document.getElementById(id)}
  const buyEl = $('buy'), sellEl = $('sell'), qtyEl = $('qty'), lotEl = $('lot')
  const addBtn = $('addBtn'), clearBtn = $('clearBtn'), clearAllBtn = $('clearAllBtn')
  const recordsEl = $('records')

  // Zerodha-like defaults
  const BROKER_PER_ORDER = 20 // ₹20 per executed order
  const GST_RATE = 0.18
  const STT_RATE = 0.000625 // 0.0625% on sell-side premium
  const EXCHANGE_RATE = 0.000355 // Zerodha-aligned exchange rate
  const SEBI_RATE = 0.000001 // tiny
  const STAMP_RATE = 0.00003 // tiny on buy

  function num(v){const n = Number(v); return isNaN(n)?0:n}
  function fmt(n){ return '₹ ' + (Math.round(n*100)/100).toLocaleString('en-IN') }

  // internal state: list of records
  const records = []

  function renderRecords(){
    recordsEl.innerHTML = ''
    records.forEach((rec, i) => {
      const div = document.createElement('div')
      div.className = 'record'
      div.innerHTML = `
        <div class="meta">
          <div><strong>#${i+1}</strong></div>
          <div>Buy: ${rec.buy}</div>
          <div>Sell: ${rec.sell}</div>
          <div>Qty: ${rec.qty}</div>
          <div>Lot: ${rec.lot}</div>
          <div>Units: ${rec.units}</div>
          <div>Profit: ${fmt(rec.totalProfit)}</div>
          <div><button data-i="${i}">Remove</button></div>
        </div>
      `
      recordsEl.appendChild(div)
    })

    // attach remove handlers
    recordsEl.querySelectorAll('button[data-i]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const idx = Number(e.currentTarget.getAttribute('data-i'))
        records.splice(idx,1)
        renderRecords()
        renderAggregate()
      })
    })

    // render aggregate at bottom
    renderAggregate()
  }

  function renderAggregate(){
    // compute aggregate values
    if(records.length === 0) return

    let totalPrincipal = 0
    let totalProfit = 0
    let weightedPctSum = 0
    let totalUnits = 0

    records.forEach(rec => {
      totalPrincipal += rec.buy * rec.units
      totalProfit += rec.totalProfit
      totalUnits += rec.units
      const pct = rec.buy ? ((rec.sell - rec.buy) / rec.buy) * 100 : 0
      weightedPctSum += pct * rec.units
    })

    const avgPct = totalUnits ? (weightedPctSum / totalUnits) : 0

    // compute charges across combined trades (round each line item to 2dp)
    const buyTurn = records.reduce((s,r)=>s + r.buy * r.units, 0)
    const sellTurn = records.reduce((s,r)=>s + r.sell * r.units, 0)
    const turnover = buyTurn + sellTurn
    const executedOrders = records.reduce((s,r)=>s + ((r.buy>0?1:0) + (r.sell>0?1:0)), 0)

    const brokerage = Math.round((BROKER_PER_ORDER * executedOrders)*100)/100
    const stt = Math.round((sellTurn * STT_RATE)*100)/100
    const exchange = Math.round((turnover * EXCHANGE_RATE)*100)/100
    const sebi = Math.round((turnover * SEBI_RATE)*100)/100
    const stamp = Math.round((buyTurn * STAMP_RATE)*100)/100
    const gst = Math.round(((brokerage + exchange + sebi) * GST_RATE)*100)/100
    const totalCharges = Math.round((brokerage + stt + exchange + gst + sebi + stamp)*100)/100

    const net = Math.round((totalProfit - totalCharges)*100)/100

    // remove existing aggregate if any
    const existing = recordsEl.querySelector('.aggregate')
    if(existing) existing.remove()

    const agg = document.createElement('div')
    agg.className = 'record aggregate'
    agg.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
        <div style="font-weight:700">Aggregates</div>
        <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap">
          <div>Target %: <strong>${Math.round(avgPct*100)/100}%</strong></div>
          <div>Principal: <strong>${fmt(totalPrincipal)}</strong></div>
          <div>Total Profit: <strong>${fmt(Math.round(totalProfit*100)/100)}</strong></div>
          <div>Net P&L: <strong class="${net>=0? 'profit' : 'loss'}">${fmt(net)}</strong></div>
        </div>
      </div>
    `

    recordsEl.appendChild(agg)
  }

  function addRecordFromInputs(){
    const buy = num(buyEl.value)
    const sell = num(sellEl.value)
    const qty = Math.max(0, Math.trunc(num(qtyEl.value)))
    const lot = Math.max(1, Math.trunc(num(lotEl.value)))
    if(!buy || !sell) return alert('Enter Buy and Sell prices before adding')

    const units = qty * lot
    const profitPerUnit = sell - buy
    const totalProfit = profitPerUnit * units

    records.push({buy,sell,qty,lot,units,profitPerUnit,totalProfit})
    renderRecords()
  }

  function clearInputs(){ buyEl.value=''; sellEl.value=''; qtyEl.value='1'; lotEl.value='75' }
  function clearAll(){ records.length = 0; renderRecords(); }

  addBtn.addEventListener('click', addRecordFromInputs)
  clearBtn.addEventListener('click', clearInputs)
  clearAllBtn.addEventListener('click', clearAll)

  // live update current inputs (non-persistent) — show live aggregate including current inputs
  function debounce(fn, ms){ let t=null; return function(){ clearTimeout(t); var args=arguments; t = setTimeout(function(){ fn.apply(null,args) }, ms) }}
  const live = debounce(function(){
    const buy = num(buyEl.value), sell = num(sellEl.value), qty = Math.max(0, Math.trunc(num(qtyEl.value))), lot = Math.max(1, Math.trunc(num(lotEl.value)))
    if(buy && sell){
      // temporary single-record calc (without adding)
      const units = qty * lot
      const totalProfit = (sell - buy) * units
      // show a temporary aggregate record at bottom (not persisted)
      // compute charges for this single input
      const brokerage = Math.round((BROKER_PER_ORDER * ((buy>0?1:0)+(sell>0?1:0)))*100)/100
      const stt = Math.round((sell * units * STT_RATE)*100)/100
      const exchange = Math.round(((buy*units + sell*units) * EXCHANGE_RATE)*100)/100
      const sebi = Math.round(((buy*units + sell*units) * SEBI_RATE)*100)/100
      const stamp = Math.round((buy*units * STAMP_RATE)*100)/100
      const gst = Math.round(((brokerage + exchange + sebi) * GST_RATE)*100)/100
      const totalCharges = Math.round((brokerage + stt + exchange + gst + sebi + stamp)*100)/100
      const net = Math.round((totalProfit - totalCharges)*100)/100

      // remove existing aggregate and render temporary one
      const existing = recordsEl.querySelector('.aggregate')
      if(existing) existing.remove()

      const agg = document.createElement('div')
      agg.className = 'record aggregate'
      const pct = buy ? ((sell - buy) / buy) * 100 : 0
      agg.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
          <div style="font-weight:700">Preview</div>
          <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap">
            <div>Target %: <strong>${Math.round(pct*100)/100}%</strong></div>
            <div>Principal: <strong>${fmt(buy * units)}</strong></div>
            <div>Total Profit: <strong>${fmt(Math.round(totalProfit*100)/100)}</strong></div>
            <div>Net P&L: <strong class="${net>=0? 'profit' : 'loss'}">${fmt(net)}</strong></div>
          </div>
        </div>
      `
      recordsEl.appendChild(agg)

    } else if(records.length>0){
      renderAggregate()
    } else {
      // remove aggregate if present
      const existing = recordsEl.querySelector('.aggregate')
      if(existing) existing.remove()
    }
  },200)

  ;[buyEl,sellEl,qtyEl,lotEl].forEach(el => el.addEventListener('input', live))

})();
</script>
</body>
</html>
